# Health Probe
k8s 자동화를 위해서 어플리케이션 실행 여부와 요청 처리 가능한지 감지할 수 있어야 하기 때문에 애플리케이션에서는 상태를 유추 가능하도록 해야 한다.

k8s는 상태를 주기적으로 확인하고 문제가 감지되면 컨테이너를 재시작 하는데 정상상태 결정 유무 판단에서 문제가 있을수 있다. (OOM 발생했지만 프로세스는 살아 있다든지.)
정상상태 판단을 위해서 체크할 수 있는 신뢰할 만한 방법이 필요하다.

소프트웨어 구현시 버그가 없는건 불가능하다. 점점 복잡해지는 서비스에선 더욱 그렇다. 


## Health check
컨테이너 프로세스에 대해 지속적으로 정상상태 확인하는 간단한 방법.


---
## Liveness probe
컨테이너가 정상적으로 동작하고 있는지를 확인합니다. 만약 프로브(Probe) 검사가 실패하면 K8s는 컨테이너를 강제 종료(Kill)하고 자동으로 재시작(Restart) 합니다.

- 컨테이너가 응답하지 않거나, 비정상적인 상태일 때 감지
- 프로브가 실패하면 컨테이너를 강제 종료 후 재시작
- 애플리케이션이 오래 실행되면서 자체적으로 회복할 수 없는 경우에 유용

```yaml
apiVersion: v1
kind: Pod
...
spec:
  containers:
    ...
    livenessProbe:
      httpGet:                  # 정상상태 점검
        path: /actutator/health
        port: 8080
      initialDeaplySeconds: 30  # 딜레이 시간
      periodSeconds: 5          # 이후 5초마다 검사
      failureThreshold: 3       # 3번 연속 실패 시 컨테이너 재시작
```
> [!WARNING]
> 정상상태 점검에서 통과하지 못하면 컨테이너를 재시작 한다.  
> - 잘못된 Liveness Probe 설정은 컨테이너가 계속 재시작되게 만들 수 있음
> - Liveness Probe는 애플리케이션이 완전히 죽었을 때만 재시작을 유도하는 것이 좋음


---
## Readiness Probe
애플리케이션이 외부 요청을 받을 준비가 되었는지 확인합니다. 만약 프로브 검사에 실패하면 서비스에서 임시적으로 제거되지만, 컨테이너는 종료되지 않습니다.

`Liveness probe`는 비정상적인 컨테이너를 새로운 컨테이너로 대체함으로 정상 상태를 유지하는데 유용하지만 때로는 재시작도 도움이 안될때도 있다.
(컨테이너의 애플리케이션이 여전히 준비중이고 잠깐의 과부하 등)

- 컨테이너가 정상적으로 실행 중이지만, 아직 요청을 받을 준비가 되지 않은 경우를 감지
- 프로브가 실패하면 컨테이너를 서비스에서 제거하지만, 강제 종료되지 않음
- 점검 실패시 컨테이너를 재시작하지 않고 트래픽을 수신하지 못하도록 한다.
- **애플리케이션이 초기 부팅 시간이 긴 경우 유용**

> [!NOTE]
> K8s는 `SIGTERM` 신호를 수신한 후에는 컨테이너로 요청을 받지 못하도록 만든다.

```yaml
apiVersion: v1
kind: Pod
...
spec:
  containers:
     ...
     readinessProbe:
       exec:
         command: [ "stat", "/var/run/is_application_ready" ] 
      initialDelaySeconds: 5   # 컨테이너 시작 후 5초 후 첫 체크
      periodSeconds: 3         # 이후 3초마다 검사
      failureThreshold: 2      # 2번 연속 실패 시 서비스에서 제외
```

> [!TIP]
> 애플리케이션의 초기 부팅이 느릴 경우 Readiness Probe 설정이 없으면 트래픽이 실패할 수 있음


## Liveness Probe vs Readiness Probe
대부분의 경우 두개 설정을 동시에 설정하는게 좋음

| 항목 | Liveness Probe | Readiness Probe |
|------|-------|--------|
| 목적 | 컨테이너가 정상적으로 작동하는지 확인 | 컨테이너가 트래픽을 받을 준비가 되었는지 확인 |
| 동작 | 실패시 컨테이너를 강제 종료 호 재시작 | 실패시 트래픽을 임시적으로 제외 |
| 주사용 목적 | 애플리케이션이 응답 하지 않는 경우 | 초기 부팅 시간이 길거나 과부화 상태일때 |
| 실패 후 결과 | 컨테이너 종료 후 재시작 | 서비스에서 일시적 제외, 컨테이너는 유지 |


